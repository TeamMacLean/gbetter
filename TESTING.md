# GBetter Testing Plan

## Overview

Comprehensive test suite covering unit tests, component tests, E2E tests, and visual regression.

## Test Stack

| Layer | Tool | Purpose |
|-------|------|---------|
| Unit | Vitest | Pure functions (parsers, GQL, utilities) |
| Component | Playwright | Canvas-based components (need real browser) |
| E2E | Playwright | Full user flows |
| Visual Regression | Playwright (`toHaveScreenshot()`) | Track rendering, themes |

## Directory Structure

```
tests/
├── unit/                    # Vitest - pure functions
│   ├── parsers/
│   │   ├── bed.test.ts
│   │   ├── gff3.test.ts
│   │   ├── vcf.test.ts
│   │   └── bedgraph.test.ts
│   ├── gql/
│   │   ├── parser.test.ts
│   │   └── executor.test.ts
│   ├── genome.test.ts       # coordinate parsing/formatting
│   └── themes.test.ts       # theme color definitions
│
├── e2e/                     # Playwright - full browser
│   ├── smoke.test.ts        # critical paths
│   ├── navigation.test.ts   # pan, zoom, URL state
│   ├── tracks.test.ts       # load files, display
│   ├── queries.test.ts      # GQL execution
│   └── visual/              # visual regression
│       ├── gene-models.test.ts
│       ├── themes.test.ts
│       └── tracks.test.ts
│
├── fixtures/                # test data (copy from test-data/)
│   ├── sample.bed
│   ├── sample.gff3
│   ├── sample.bedgraph
│   └── sample.vcf
│
└── screenshots/             # visual regression baselines
    └── (auto-generated by Playwright)
```

## Implementation Phases

### Phase 1: Infrastructure Setup
- [ ] Install Vitest with SvelteKit config
- [ ] Install Playwright with proper config
- [ ] Configure test scripts in package.json
- [ ] Set up fixtures directory

### Phase 2: Unit Tests (Parsers)
- [ ] BED parser tests (BED3, BED6, BED12, edge cases)
- [ ] GFF3 parser tests (parent-child, attributes, edge cases)
- [ ] VCF parser tests (variants, INFO fields)
- [ ] bedGraph parser tests (signal values)
- [ ] Coordinate parsing/formatting tests

### Phase 3: Unit Tests (GQL)
- [ ] GQL parser tests (all command types)
- [ ] GQL executor tests (with mock data)
- [ ] WHERE clause evaluation
- [ ] ORDER BY / LIMIT
- [ ] INTERSECT / WITHIN logic

### Phase 4: E2E Smoke Tests
- [ ] App loads without errors
- [ ] Load BED file → track appears
- [ ] Load GFF3 file → gene models render
- [ ] Navigate to coordinates
- [ ] Run GQL query → results appear
- [ ] URL state persists on reload

### Phase 5: Visual Regression
- [ ] Gene model rendering (dark theme)
- [ ] Gene model rendering (flat theme)
- [ ] BED track rendering
- [ ] Signal track rendering
- [ ] VCF variant rendering
- [ ] Different zoom levels

### Phase 6: Component Tests
- [ ] Sidebar track list
- [ ] Header coordinate input
- [ ] Query console interactions
- [ ] Assembly selector

## Test Commands

```bash
# Unit tests
npm run test:unit

# E2E tests
npm run test:e2e

# Visual regression (updates baselines)
npm run test:visual -- --update-snapshots

# All tests
npm test
```

## Visual Regression Strategy

Using Playwright's built-in `toHaveScreenshot()`:

```typescript
test('gene model dark theme', async ({ page }) => {
  await page.goto('/?loc=chr17:7668421-7687490');
  await loadFixture(page, 'genes.gff3');

  // Wait for render
  await page.waitForTimeout(500);

  // Full viewport screenshot
  await expect(page).toHaveScreenshot('gene-model-dark.png', {
    maxDiffPixelRatio: 0.01,  // 1% tolerance
  });
});
```

Baseline images stored in `tests/screenshots/` and committed to repo.

## CI Integration (Future)

```yaml
# .github/workflows/test.yml
- run: npm run test:unit
- run: npx playwright install
- run: npm run test:e2e
```

---

## Persona-Based Acceptance Tests

These tests validate the app is **fit for purpose**, not just technically correct. Each persona represents a real user archetype with specific workflows.

### Persona 1: Sam the Student (Beginner)

**Background**: Undergraduate taking a genomics course, first time using a genome browser.

**Use case**: "My professor mentioned TP53 is an important tumor suppressor. I want to see what it looks like."

**Workflow**:
1. Open the browser (should load without errors)
2. Search for "TP53" in the search bar
3. Navigate to the gene location
4. Zoom in to see exon structure
5. Zoom out to see genomic context
6. Load a sample file (drag and drop)

**Test file**: `tests/e2e/personas/student.test.ts`

**Validates**:
- [ ] App loads cleanly for first-time user
- [ ] Gene search works with common names
- [ ] Navigation is intuitive
- [ ] Zoom controls work
- [ ] File loading is discoverable

---

### Persona 2: Maya the Bench Biologist (Intermediate)

**Background**: Wet lab scientist with a gene list from RNA-seq experiment.

**Use case**: "I have 20 differentially expressed genes. Do any overlap with known variants?"

**Workflow**:
1. Load her gene list (BED file with gene regions)
2. Load a variants file (VCF)
3. Natural language: "show me genes with variants"
4. See list of overlapping features
5. Click a result to navigate there
6. Examine the gene/variant overlap visually

**Test file**: `tests/e2e/personas/biologist.test.ts`

**Validates**:
- [ ] Multiple track loading works
- [ ] Tracks display correctly together
- [ ] Natural language → GQL translation
- [ ] INTERSECT queries work
- [ ] Result clicking navigates viewport

---

### Persona 3: Jordan the Bioinformatician (Advanced)

**Background**: Computational biologist doing QC on sequencing data.

**Use case**: "I need to check my ChIP-seq peaks overlap with promoters and filter by signal strength."

**Workflow**:
1. Load peaks (BED with scores)
2. Load signal track (bedGraph)
3. Load gene annotations (GFF3)
4. GQL: `SELECT * FROM peaks WHERE score > 100`
5. GQL: `SELECT GENES INTERSECT peaks IN VIEW`
6. Switch between dark/flat themes to visualize
7. Pan/zoom to inspect specific regions

**Test file**: `tests/e2e/personas/bioinformatician.test.ts`

**Validates**:
- [ ] Three track types load together
- [ ] WHERE clause filtering works
- [ ] Score/numeric comparisons
- [ ] Theme switching updates display
- [ ] Complex queries return correct results

---

### Persona 4: Elena the Plant Pathologist (Domain Expert)

**Background**: Studies fungal wheat pathogens, works with non-model genomes.

**Use case**: "I'm analyzing Zymoseptoria tritici effector genes on chromosome 7."

**Workflow**:
1. Open assembly selector
2. Find and select "Zymoseptoria tritici"
3. Load her annotated effector genes (GFF3)
4. Navigate to chromosome 7
5. Search for a specific effector gene by name
6. See chromosome mismatch warning if wrong file loaded
7. Use "inferred from data" if custom assembly needed

**Test file**: `tests/e2e/personas/pathologist.test.ts`

**Validates**:
- [ ] Assembly selector shows all 27+ genomes
- [ ] Non-human assemblies work correctly
- [ ] Chromosome names update in dropdown
- [ ] Mismatch warnings appear appropriately
- [ ] "Inferred from data" creates working assembly
- [ ] Custom chrom.sizes loading works

---

### Persona 5: Alex the Power Analyst (Expert)

**Background**: Leads a genomics core facility, needs reproducible analyses.

**Use case**: "Find the 10 longest genes with HIGH impact variants, share the view with a collaborator."

**Workflow**:
1. Load genes (GFF3) and variants (VCF)
2. Open query console (Cmd+`)
3. Write GQL: `SELECT GENES FROM genes INTERSECT variants ORDER BY length DESC LIMIT 10`
4. Review results in table
5. Save query with name and description
6. Copy shareable URL
7. Open URL in new tab - verify state restored
8. Export query to .gql file

**Test file**: `tests/e2e/personas/analyst.test.ts`

**Validates**:
- [ ] Query console opens with keyboard shortcut
- [ ] Complex GQL with ORDER BY, LIMIT executes
- [ ] FROM clause targets specific track
- [ ] Results display in sortable table
- [ ] Query save/load works
- [ ] URL contains viewport state
- [ ] URL sharing restores exact view
- [ ] Export produces valid .gql file

---

## Persona Test Implementation

Each persona test is a complete user journey:

```typescript
// tests/e2e/personas/student.test.ts
import { test, expect } from '@playwright/test';

test.describe('Sam the Student - First-time user journey', () => {
  test('can search for and explore TP53', async ({ page }) => {
    // Fresh start
    await page.goto('/');

    // Search for gene
    await page.fill('[data-testid="search-input"]', 'TP53');
    await page.press('[data-testid="search-input"]', 'Enter');

    // Should navigate to TP53 region
    await expect(page.locator('.coordinate-display'))
      .toContainText('chr17');

    // Zoom in
    await page.click('[title="Zoom in"]');

    // Visual check
    await expect(page).toHaveScreenshot('student-tp53-zoomed.png');
  });

  test('can load sample file via drag and drop', async ({ page }) => {
    await page.goto('/');

    // Simulate file drop
    await page.setInputFiles('input[type="file"]',
      'tests/fixtures/sample-genes.bed');

    // Track should appear
    await expect(page.locator('.track-name'))
      .toContainText('sample-genes');
  });
});
```

## Test Data Requirements

Each persona needs appropriate fixture files:

| Persona | Fixtures Needed |
|---------|-----------------|
| Student | None (uses search) + sample.bed |
| Biologist | genes.bed, variants.vcf |
| Bioinformatician | peaks.bed, signal.bedgraph, genes.gff3 |
| Pathologist | ztritici-genes.gff3, custom.chrom.sizes |
| Analyst | genes.gff3, variants-with-impact.vcf |

---

## Success Criteria

All persona tests passing means:
1. ✅ App works for beginners through experts
2. ✅ Core workflows are functional
3. ✅ Non-human genomes are supported
4. ✅ Reproducibility features work
5. ✅ The app is fit for purpose

